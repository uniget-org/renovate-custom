passage-check:
  image: registry.gitlab.com/uniget-org/images/ubuntu:rolling
  script:
  - |
    git clone https://github.com/FiloSottile/passage

    VERSION="$(git -C passage rev-list --count --all)"
    if test -z "${VERSION}"; then
        echo "Failed to count commits"
        exit 1
    fi

    COMMIT="$(git -C passage rev-parse --short HEAD)"
    if test -z "${COMMIT}"; then
        echo "Failed to get short commit hash"
        exit 1
    fi
    
    echo "Got version <${VERSION}.${COMMIT}>"

    echo "VERSION=${VERSION}.${COMMIT}" >>variables.env
  artifacts:
    reports:
      dotenv: variables.env

passage-release:
  needs:
  - passage-check
  image: registry.gitlab.com/gitlab-org/release-cli:v0.19.0
  script:
  - |
    echo "### Releasing passage v${VERSION}"
    if release-cli get --tag-name passage/${VERSION}; then
        echo "    Already exists"
        exit 0

    else
        release-cli create \
            --name "passage v${VERSION}" \
              --description "Custom release of passage v${VERSION}" \
              --tag-name "passage/${VERSION}" \
              --ref "${CI_COMMIT_SHA}"
    fi
